graph TB
    subgraph "Signal Producers Layer [N个进程]"
        subgraph "Market Data Producers"
            BMP[Binance Market Producer<br/>双路WebSocket<br/>10ms盘口数据]
            OMP[OKEx Market Producer<br/>depth高频数据<br/>10s频率]
            BYP[Bybit Market Producer<br/>订阅数据<br/>双路保证]
        end
        
        subgraph "Strategy Signal Producers"
            FRP[Funding Rate Producer<br/>资金费率信号<br/>60s更新/方向判断]
            PSP[Position Signal Producer<br/>平仓信号生产<br/>止盈止损/超时平仓]
            ASP[Alert Signal Producer<br/>风控告警信号<br/>异常检测]
        end
    end
    
    subgraph "IPC Communication Layer"
        IPC[iceoryx2 Zero-Copy IPC<br/>Publisher/Subscriber模式<br/>延迟 < 1μs<br/>吞吐量 > 1M msg/s]
        ZMQ[ZeroMQ Backup<br/>备用通道]
    end
    
    subgraph "Signal Collector Process [单线程Tokio]"
        SCM[Signal Manager<br/>HashMap信号状态维护]
        TRG[Trigger Registry<br/>触发器链表管理]
        EVG[Event Generator<br/>交易事件生成器]
        
        subgraph "Triggers"
            MTT[MT Strategy Trigger<br/>套利策略触发器]
            CLT[Close Position Trigger<br/>平仓触发器]
            HDT[Hedge Trigger<br/>对冲触发器]
        end
        
        SCM --> TRG
        TRG --> MTT
        TRG --> CLT
        TRG --> HDT
        MTT --> EVG
        CLT --> EVG
        HDT --> EVG
    end
    
    subgraph "Pre/Post Processor [单线程/无锁]"
        subgraph "Pre-Process Pipeline"
            AGE[Age Check<br/>信号时效性]
            RSK[Risk Control<br/>风控检查]
            POS[Position Check<br/>仓位限制]
            ORD[Order Builder<br/>订单构造]
            PRI[Priority Queue<br/>优先级队列]
        end
        
        subgraph "Shared State"
            RSS[Risk State<br/>风控状态]
            OBK[Order Book<br/>订单簿]
            PST[Position State<br/>仓位状态]
            ARB[Arbitrage Pairs<br/>套利组合]
        end
        
        subgraph "Post-Process Pipeline"
            UPD[Position Update<br/>仓位更新]
            QTA[Quota Release<br/>额度释放]
            HGT[Hedge Trigger<br/>对冲触发]
            PNL[PnL Calculator<br/>盈亏计算]
        end
        
        AGE --> RSK --> POS --> ORD --> PRI
        UPD --> QTA --> HGT --> PNL
        
        RSS -.-> RSK
        RSS -.-> QTA
        OBK -.-> ORD
        OBK -.-> UPD
        PST -.-> POS
        PST -.-> UPD
        ARB -.-> HGT
    end
    
    subgraph "Trading Engine Process [无状态设计]"
        subgraph "Connection Management"
            WSM[WS Pool Manager<br/>连接池管理<br/>健康度评分]
            SWS[Spot WebSockets<br/>3个连接<br/>轮询+健康检查]
            FWS[Futures WebSockets<br/>3个连接<br/>自动重连]
        end
        
        subgraph "Execution Core"
            RTR[Order Router<br/>智能路由]
            SGN[Signer<br/>签名生成]
            IDP[Idempotent Sender<br/>幂等发送器<br/>ClientOrderId]
            EXE[Executor<br/>并发执行器]
        end
        
        subgraph "Response Processing"
            PRS[Response Parser<br/>回报解析]
            HND[Handler Chain<br/>处理链]
            EVT[Event Emitter<br/>事件发射器]
        end
        
        WSM --> SWS
        WSM --> FWS
        RTR --> SGN --> IDP --> EXE
        PRS --> HND --> EVT
    end
    
    subgraph "Exchange APIs"
        subgraph "Binance"
            BSA[Binance Spot API<br/>现货交易]
            BFA[Binance Futures API<br/>合约交易]
        end
        
        subgraph "Other Exchanges"
            OKX[OKEx API]
            BYB[Bybit API]
        end
    end
    
    %% 主要数据流
    BMP --> IPC
    OMP --> IPC
    BYP --> IPC
    FRP --> IPC
    PSP --> IPC
    ASP --> IPC
    
    IPC --> SCM
    ZMQ -.-> SCM
    
    EVG -->|Trading Event| AGE
    PRI -->|Execution Command| RTR
    
    EXE --> BSA
    EXE --> BFA
    EXE --> OKX
    EXE --> BYB
    
    BSA -.->|Order Response| PRS
    BFA -.->|Order Response| PRS
    
    EVT -.->|Fill Report| UPD
    HGT -.->|Hedge Signal| SCM
    
    %% 样式
    style IPC fill:#2196F3,color:#fff
    style SCM fill:#667eea,color:#fff
    style RSS fill:#FFC107,color:#000
    style WSM fill:#4CAF50,color:#fff
    style BSA fill:#f44336,color:#fff
    style BFA fill:#f44336,color:#fff