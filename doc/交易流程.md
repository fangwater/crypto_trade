sequenceDiagram
    participant FP as Funding Producer
    participant MP as Market Producer
    participant PP as Position Producer
    participant SC as Signal Collector
    participant PRE as Pre/Post Process
    participant TE as Trading Engine
    participant EX as Exchange
    
    Note over FP,EX: MT策略执行链路：信号汇聚→触发→分叉→对冲
    
    %% 信号汇聚阶段
    rect rgb(240, 248, 255)
        Note over FP,SC: 信号汇聚阶段
        FP->>SC: FundingRateSignal
        MP->>SC: MarketDataSignal
        Note over SC: 信号状态更新<br/>多信号汇聚
    end
    
    %% Trigger评估
    rect rgb(255, 245, 230)
        Note over SC: Trigger评估阶段
        SC->>SC: MTTrigger.evaluate()
        Note over SC: 触发条件满足<br/>生成交易事件
        SC->>PRE: TradingEvent
    end
    
    %% Pre-Process处理
    rect rgb(245, 255, 245)
        Note over PRE: Pre-Process Pipeline
        PRE->>PRE: 风控检查链
        PRE->>PRE: 订单构造
        PRE->>TE: ExecutionCommand
    end
    
    %% 现货执行分支
    rect rgb(255, 240, 240)
        Note over TE,EX: 现货执行分支
        
        par 多路并发
            TE->>EX: WebSocket路径1
        and
            TE->>EX: WebSocket路径2
        and
            TE->>EX: WebSocket路径3(备用)
        end
        
        EX-->>TE: OrderResponse
        TE->>PRE: 执行回报
    end
    
    %% 信号分叉点 - 关键
    rect rgb(255, 248, 220)
        Note over PRE: 信号分叉点：Post-Process
        PRE->>PRE: 成交处理
        
        par 信号分叉
            PRE->>PRE: 分支1: 仓位更新
        and
            PRE->>SC: 分支2: 对冲信号
        and
            PRE->>PRE: 分支3: 风控更新
        end
    end
    
    %% 对冲链路（循环回到SC）
    rect rgb(240, 240, 255)
        Note over SC,EX: 对冲执行链路（优先级最高）
        SC->>SC: HedgeTrigger<br/>(直接触发)
        SC->>PRE: HedgeEvent
        PRE->>PRE: 快速通道<br/>(跳过部分检查)
        PRE->>TE: HedgeCommand<br/>Priority=HIGHEST
        TE->>EX: 合约对冲单
        EX-->>TE: HedgeResponse
        TE->>PRE: 对冲回报
    end
    
    %% 最终状态收敛
    rect rgb(230, 255, 230)
        Note over PRE: 状态收敛阶段
        PRE->>PRE: 套利组合形成
        PRE->>PRE: 净敞口归零
        Note over PRE: 等待下一周期
    end
    
    %% 平仓链路（独立触发）
    Note over PP,EX: 平仓链路（独立触发）
    PP-->>SC: ClosePositionSignal
    SC-->>SC: CloseTrigger
    SC-->>PRE: CloseEvent
    
    par 平仓并发执行
        PRE-->>TE: 现货平仓
    and
        PRE-->>TE: 合约平仓
    end